{"version":3,"file":"build.test.mjs","names":["assert","YError","initInitializerBuilder","Knifecycle","initializer","constant","describe","aProvider","service","mockedDepsHash","NODE_ENV","dep1","inject","type","name","dep2","dep3","initAutoloader","singleton","$autoload","Promise","resolve","path","reject","it","$","register","buildInitializer","run","content","equal","modules"],"sources":["../src/build.test.ts"],"sourcesContent":["import assert from 'assert';\nimport YError from 'yerror';\nimport initInitializerBuilder from './build';\nimport Knifecycle, { initializer, constant } from '.';\nimport type { BuildInitializer } from './build';\n\ndescribe('buildInitializer', () => {\n  async function aProvider() {\n    return {\n      service: 'PROVIDER_SERVICE',\n    };\n  }\n  const mockedDepsHash = {\n    NODE_ENV: constant('NODE_ENV', 'development'),\n    dep1: initializer(\n      {\n        inject: [],\n        type: 'service',\n        name: 'dep1',\n      },\n      aProvider,\n    ),\n    dep2: initializer(\n      {\n        inject: ['dep1', 'NODE_ENV'],\n        type: 'provider',\n        name: 'dep2',\n      },\n      aProvider,\n    ),\n    dep3: initializer(\n      {\n        inject: ['dep2', 'dep1', '?depOpt'],\n        type: 'service',\n        name: 'dep3',\n      },\n      aProvider,\n    ),\n  };\n  const initAutoloader = initializer(\n    {\n      name: '$autoload',\n      type: 'service',\n      inject: [],\n      singleton: true,\n    },\n    async () => {\n      return async function $autoload(name) {\n        return mockedDepsHash[name]\n          ? Promise.resolve({\n              path: `./services/${name}`,\n              initializer: mockedDepsHash[name],\n            })\n          : Promise.reject(new YError('E_UNMATCHED_DEPENDENCY', name));\n      };\n    },\n  );\n\n  it('should build an initialization module', async () => {\n    const $ = new Knifecycle();\n\n    $.register(constant('PWD', '~/my-project'));\n    $.register(initAutoloader);\n    $.register(initInitializerBuilder);\n\n    const { buildInitializer } = await $.run<{\n      buildInitializer: BuildInitializer;\n    }>(['buildInitializer']);\n\n    const content = await buildInitializer(['dep1', 'finalMappedDep>dep3']);\n    assert.equal(\n      content,\n      `\n// Definition batch #0\nimport initDep1 from './services/dep1';\nconst NODE_ENV = \"development\";\n\n// Definition batch #1\nimport initDep2 from './services/dep2';\n\n// Definition batch #2\nimport initDep3 from './services/dep3';\n\nexport async function initialize(services = {}) {\n  // Initialization batch #0\n  const batch0 = {\n    dep1: initDep1({\n    }),\n    NODE_ENV: Promise.resolve(NODE_ENV),\n  };\n\n  await Promise.all(\n    Object.keys(batch0)\n    .map(key => batch0[key])\n  );\n\n  services['dep1'] = await batch0['dep1'];\n  services['NODE_ENV'] = await batch0['NODE_ENV'];\n\n  // Initialization batch #1\n  const batch1 = {\n    dep2: initDep2({\n      dep1: services['dep1'],\n      NODE_ENV: services['NODE_ENV'],\n    }).then(provider => provider.service),\n  };\n\n  await Promise.all(\n    Object.keys(batch1)\n    .map(key => batch1[key])\n  );\n\n  services['dep2'] = await batch1['dep2'];\n\n  // Initialization batch #2\n  const batch2 = {\n    dep3: initDep3({\n      dep2: services['dep2'],\n      dep1: services['dep1'],\n      depOpt: services['depOpt'],\n    }),\n  };\n\n  await Promise.all(\n    Object.keys(batch2)\n    .map(key => batch2[key])\n  );\n\n  services['dep3'] = await batch2['dep3'];\n\n  return {\n    dep1: services['dep1'],\n    finalMappedDep: services['dep3'],\n  };\n}\n`,\n    );\n  });\n\n  it('should allows to use commonjs', async () => {\n    const $ = new Knifecycle();\n\n    $.register(constant('PWD', '~/my-project'));\n    $.register(initAutoloader);\n    $.register(initInitializerBuilder);\n\n    const { buildInitializer } = await $.run<{\n      buildInitializer: BuildInitializer;\n    }>(['buildInitializer']);\n\n    const content = await buildInitializer(['dep1', 'finalMappedDep>dep3'], {\n      modules: 'commonjs',\n    });\n    assert.equal(\n      content,\n      `\n// Definition batch #0\nconst initDep1 = (() => { const m = require('./services/dep1'); return m && m.default || m; })();\nconst NODE_ENV = \"development\";\n\n// Definition batch #1\nconst initDep2 = (() => { const m = require('./services/dep2'); return m && m.default || m; })();\n\n// Definition batch #2\nconst initDep3 = (() => { const m = require('./services/dep3'); return m && m.default || m; })();\n\nmodule.exports = {}; module.exports.initialize = async function initialize(services = {}) {\n  // Initialization batch #0\n  const batch0 = {\n    dep1: initDep1({\n    }),\n    NODE_ENV: Promise.resolve(NODE_ENV),\n  };\n\n  await Promise.all(\n    Object.keys(batch0)\n    .map(key => batch0[key])\n  );\n\n  services['dep1'] = await batch0['dep1'];\n  services['NODE_ENV'] = await batch0['NODE_ENV'];\n\n  // Initialization batch #1\n  const batch1 = {\n    dep2: initDep2({\n      dep1: services['dep1'],\n      NODE_ENV: services['NODE_ENV'],\n    }).then(provider => provider.service),\n  };\n\n  await Promise.all(\n    Object.keys(batch1)\n    .map(key => batch1[key])\n  );\n\n  services['dep2'] = await batch1['dep2'];\n\n  // Initialization batch #2\n  const batch2 = {\n    dep3: initDep3({\n      dep2: services['dep2'],\n      dep1: services['dep1'],\n      depOpt: services['depOpt'],\n    }),\n  };\n\n  await Promise.all(\n    Object.keys(batch2)\n    .map(key => batch2[key])\n  );\n\n  services['dep3'] = await batch2['dep3'];\n\n  return {\n    dep1: services['dep1'],\n    finalMappedDep: services['dep3'],\n  };\n}\n`,\n    );\n  });\n});\n"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,QAAnB;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,OAAOC,sBAAP,MAAmC,SAAnC;AACA,OAAOC,UAAP,IAAqBC,WAArB,EAAkCC,QAAlC,QAAkD,GAAlD;AAGAC,QAAQ,CAAC,kBAAD,EAAqB,MAAM;EACjC,eAAeC,SAAf,GAA2B;IACzB,OAAO;MACLC,OAAO,EAAE;IADJ,CAAP;EAGD;;EACD,MAAMC,cAAc,GAAG;IACrBC,QAAQ,EAAEL,QAAQ,CAAC,UAAD,EAAa,aAAb,CADG;IAErBM,IAAI,EAAEP,WAAW,CACf;MACEQ,MAAM,EAAE,EADV;MAEEC,IAAI,EAAE,SAFR;MAGEC,IAAI,EAAE;IAHR,CADe,EAMfP,SANe,CAFI;IAUrBQ,IAAI,EAAEX,WAAW,CACf;MACEQ,MAAM,EAAE,CAAC,MAAD,EAAS,UAAT,CADV;MAEEC,IAAI,EAAE,UAFR;MAGEC,IAAI,EAAE;IAHR,CADe,EAMfP,SANe,CAVI;IAkBrBS,IAAI,EAAEZ,WAAW,CACf;MACEQ,MAAM,EAAE,CAAC,MAAD,EAAS,MAAT,EAAiB,SAAjB,CADV;MAEEC,IAAI,EAAE,SAFR;MAGEC,IAAI,EAAE;IAHR,CADe,EAMfP,SANe;EAlBI,CAAvB;EA2BA,MAAMU,cAAc,GAAGb,WAAW,CAChC;IACEU,IAAI,EAAE,WADR;IAEED,IAAI,EAAE,SAFR;IAGED,MAAM,EAAE,EAHV;IAIEM,SAAS,EAAE;EAJb,CADgC,EAOhC,YAAY;IACV,OAAO,eAAeC,SAAf,CAAyBL,IAAzB,EAA+B;MACpC,OAAOL,cAAc,CAACK,IAAD,CAAd,GACHM,OAAO,CAACC,OAAR,CAAgB;QACdC,IAAI,EAAG,cAAaR,IAAK,EADX;QAEdV,WAAW,EAAEK,cAAc,CAACK,IAAD;MAFb,CAAhB,CADG,GAKHM,OAAO,CAACG,MAAR,CAAe,IAAItB,MAAJ,CAAW,wBAAX,EAAqCa,IAArC,CAAf,CALJ;IAMD,CAPD;EAQD,CAhB+B,CAAlC;EAmBAU,EAAE,CAAC,uCAAD,EAA0C,YAAY;IACtD,MAAMC,CAAC,GAAG,IAAItB,UAAJ,EAAV;IAEAsB,CAAC,CAACC,QAAF,CAAWrB,QAAQ,CAAC,KAAD,EAAQ,cAAR,CAAnB;IACAoB,CAAC,CAACC,QAAF,CAAWT,cAAX;IACAQ,CAAC,CAACC,QAAF,CAAWxB,sBAAX;IAEA,MAAM;MAAEyB;IAAF,IAAuB,MAAMF,CAAC,CAACG,GAAF,CAEhC,CAAC,kBAAD,CAFgC,CAAnC;IAIA,MAAMC,OAAO,GAAG,MAAMF,gBAAgB,CAAC,CAAC,MAAD,EAAS,qBAAT,CAAD,CAAtC;IACA3B,MAAM,CAAC8B,KAAP,CACED,OADF,EAEG;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAjEI;EAmED,CA/EC,CAAF;EAiFAL,EAAE,CAAC,+BAAD,EAAkC,YAAY;IAC9C,MAAMC,CAAC,GAAG,IAAItB,UAAJ,EAAV;IAEAsB,CAAC,CAACC,QAAF,CAAWrB,QAAQ,CAAC,KAAD,EAAQ,cAAR,CAAnB;IACAoB,CAAC,CAACC,QAAF,CAAWT,cAAX;IACAQ,CAAC,CAACC,QAAF,CAAWxB,sBAAX;IAEA,MAAM;MAAEyB;IAAF,IAAuB,MAAMF,CAAC,CAACG,GAAF,CAEhC,CAAC,kBAAD,CAFgC,CAAnC;IAIA,MAAMC,OAAO,GAAG,MAAMF,gBAAgB,CAAC,CAAC,MAAD,EAAS,qBAAT,CAAD,EAAkC;MACtEI,OAAO,EAAE;IAD6D,CAAlC,CAAtC;IAGA/B,MAAM,CAAC8B,KAAP,CACED,OADF,EAEG;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAjEI;EAmED,CAjFC,CAAF;AAkFD,CAvNO,CAAR"}