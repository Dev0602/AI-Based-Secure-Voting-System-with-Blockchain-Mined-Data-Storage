{"version":3,"file":"process.test.js","names":["describe","log","jest","fn","savedProcessName","global","process","title","processListenerStub","spyOn","exit","exitPromise","fatalErrorDeferred","beforeEach","Promise","resolve","mockClear","mockReset","afterEach","done","initProcessService","NODE_ENV","PROCESS_NAME","$instance","destroy","$fatalError","promise","reject","then","catch","test","expect","mock","calls","toEqual","length","YError","find","call","forEach","signal","Knifecycle","register","constant","run"],"sources":["../src/process.test.ts"],"sourcesContent":["import YError from 'yerror';\nimport Knifecycle, { constant } from 'knifecycle';\nimport initProcessService from './process';\n\ndescribe('Process service', () => {\n  const log = jest.fn();\n  const savedProcessName = global.process.title;\n  const processListenerStub = jest.spyOn(global.process, 'on');\n  let exit;\n  let exitPromise;\n  let fatalErrorDeferred;\n\n  beforeEach(() => {\n    exitPromise = new Promise((resolve) => {\n      exit = jest.fn(resolve);\n    });\n    processListenerStub.mockClear();\n    log.mockReset();\n  });\n\n  afterEach(() => {\n    global.process.title = savedProcessName;\n  });\n\n  describe('', () => {\n    beforeEach((done) => {\n      initProcessService({\n        NODE_ENV: 'development',\n        PROCESS_NAME: 'Kikooolol',\n        log,\n        exit,\n        $instance: { destroy: () => Promise.resolve() } as Knifecycle,\n        $fatalError: {\n          promise: new Promise((resolve, reject) => {\n            fatalErrorDeferred = { resolve, reject };\n          }),\n        },\n      })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should work', () => {\n      expect(log.mock.calls).toEqual([\n        ['warning', 'ðŸ”‚ - Running in \"development\" environment.'],\n        ['debug', 'ðŸ“‡ - Process service initialized.'],\n      ]);\n      expect(global.process.title).toEqual('Kikooolol - development');\n      expect(processListenerStub.mock.calls.length).toEqual(3);\n    });\n\n    test('should handle fatal errors', (done) => {\n      fatalErrorDeferred.reject(new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          expect(exit.mock.calls).toEqual([[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should handle uncaught exceptions', (done) => {\n      (\n        processListenerStub.mock.calls.find(\n          (call) => 'uncaughtException' === call[0],\n        ) as [unknown, (err: Error) => void]\n      )[1](new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          expect(exit.mock.calls).toEqual([[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    ['SIGINT', 'SIGTERM'].forEach((signal) =>\n      test('should handle `signal`', (done) => {\n        (\n          processListenerStub.mock.calls.find((call) => signal === call[0]) as [\n            unknown,\n            (err: Error) => void,\n          ]\n        )[1](new YError('E_AOUCH'));\n\n        exitPromise\n          .then(() => {\n            expect(exit.mock.calls).toEqual([[0]]);\n          })\n          .then(() => done())\n          .catch(done);\n      }),\n    );\n  });\n\n  test('should work with Knifecycle', (done) => {\n    new Knifecycle()\n      .register(initProcessService)\n      .register(constant('log', log))\n      .register(constant('NODE_ENV', 'production'))\n      .register(constant('exit', exit))\n      .run(['process'])\n      .then(() => {\n        expect(log.mock.calls).toEqual([\n          ['warning', 'ðŸ”‚ - Running in \"production\" environment.'],\n          ['debug', 'ðŸ“‡ - Process service initialized.'],\n        ]);\n      })\n      .then(() => done())\n      .catch(done);\n  });\n});\n"],"mappings":";;AAAA;;AACA;;AACA;;;;;;;;AAEAA,QAAQ,CAAC,iBAAD,EAAoB,MAAM;EAChC,MAAMC,GAAG,GAAGC,IAAI,CAACC,EAAL,EAAZ;EACA,MAAMC,gBAAgB,GAAGC,MAAM,CAACC,OAAP,CAAeC,KAAxC;EACA,MAAMC,mBAAmB,GAAGN,IAAI,CAACO,KAAL,CAAWJ,MAAM,CAACC,OAAlB,EAA2B,IAA3B,CAA5B;EACA,IAAII,IAAJ;EACA,IAAIC,WAAJ;EACA,IAAIC,kBAAJ;EAEAC,UAAU,CAAC,MAAM;IACfF,WAAW,GAAG,IAAIG,OAAJ,CAAaC,OAAD,IAAa;MACrCL,IAAI,GAAGR,IAAI,CAACC,EAAL,CAAQY,OAAR,CAAP;IACD,CAFa,CAAd;IAGAP,mBAAmB,CAACQ,SAApB;IACAf,GAAG,CAACgB,SAAJ;EACD,CANS,CAAV;EAQAC,SAAS,CAAC,MAAM;IACdb,MAAM,CAACC,OAAP,CAAeC,KAAf,GAAuBH,gBAAvB;EACD,CAFQ,CAAT;EAIAJ,QAAQ,CAAC,EAAD,EAAK,MAAM;IACjBa,UAAU,CAAEM,IAAD,IAAU;MACnB,IAAAC,gBAAA,EAAmB;QACjBC,QAAQ,EAAE,aADO;QAEjBC,YAAY,EAAE,WAFG;QAGjBrB,GAHiB;QAIjBS,IAJiB;QAKjBa,SAAS,EAAE;UAAEC,OAAO,EAAE,MAAMV,OAAO,CAACC,OAAR;QAAjB,CALM;QAMjBU,WAAW,EAAE;UACXC,OAAO,EAAE,IAAIZ,OAAJ,CAAY,CAACC,OAAD,EAAUY,MAAV,KAAqB;YACxCf,kBAAkB,GAAG;cAAEG,OAAF;cAAWY;YAAX,CAArB;UACD,CAFQ;QADE;MANI,CAAnB,EAYGC,IAZH,CAYQ,MAAMT,IAAI,EAZlB,EAaGU,KAbH,CAaSV,IAbT;IAcD,CAfS,CAAV;IAiBAW,IAAI,CAAC,aAAD,EAAgB,MAAM;MACxBC,MAAM,CAAC9B,GAAG,CAAC+B,IAAJ,CAASC,KAAV,CAAN,CAAuBC,OAAvB,CAA+B,CAC7B,CAAC,SAAD,EAAY,4CAAZ,CAD6B,EAE7B,CAAC,OAAD,EAAU,mCAAV,CAF6B,CAA/B;MAIAH,MAAM,CAAC1B,MAAM,CAACC,OAAP,CAAeC,KAAhB,CAAN,CAA6B2B,OAA7B,CAAqC,yBAArC;MACAH,MAAM,CAACvB,mBAAmB,CAACwB,IAApB,CAAyBC,KAAzB,CAA+BE,MAAhC,CAAN,CAA8CD,OAA9C,CAAsD,CAAtD;IACD,CAPG,CAAJ;IASAJ,IAAI,CAAC,4BAAD,EAAgCX,IAAD,IAAU;MAC3CP,kBAAkB,CAACe,MAAnB,CAA0B,IAAIS,eAAJ,CAAW,SAAX,CAA1B;MAEAzB,WAAW,CACRiB,IADH,CACQ,MAAM;QACVG,MAAM,CAACrB,IAAI,CAACsB,IAAL,CAAUC,KAAX,CAAN,CAAwBC,OAAxB,CAAgC,CAAC,CAAC,CAAD,CAAD,CAAhC;MACD,CAHH,EAIGN,IAJH,CAIQ,MAAMT,IAAI,EAJlB,EAKGU,KALH,CAKSV,IALT;IAMD,CATG,CAAJ;IAWAW,IAAI,CAAC,mCAAD,EAAuCX,IAAD,IAAU;MAEhDX,mBAAmB,CAACwB,IAApB,CAAyBC,KAAzB,CAA+BI,IAA/B,CACGC,IAAD,IAAU,wBAAwBA,IAAI,CAAC,CAAD,CADxC,CADF,CAIE,CAJF,EAIK,IAAIF,eAAJ,CAAW,SAAX,CAJL;MAMAzB,WAAW,CACRiB,IADH,CACQ,MAAM;QACVG,MAAM,CAACrB,IAAI,CAACsB,IAAL,CAAUC,KAAX,CAAN,CAAwBC,OAAxB,CAAgC,CAAC,CAAC,CAAD,CAAD,CAAhC;MACD,CAHH,EAIGN,IAJH,CAIQ,MAAMT,IAAI,EAJlB,EAKGU,KALH,CAKSV,IALT;IAMD,CAbG,CAAJ;IAeA,CAAC,QAAD,EAAW,SAAX,EAAsBoB,OAAtB,CAA+BC,MAAD,IAC5BV,IAAI,CAAC,wBAAD,EAA4BX,IAAD,IAAU;MAErCX,mBAAmB,CAACwB,IAApB,CAAyBC,KAAzB,CAA+BI,IAA/B,CAAqCC,IAAD,IAAUE,MAAM,KAAKF,IAAI,CAAC,CAAD,CAA7D,CADF,CAKE,CALF,EAKK,IAAIF,eAAJ,CAAW,SAAX,CALL;MAOAzB,WAAW,CACRiB,IADH,CACQ,MAAM;QACVG,MAAM,CAACrB,IAAI,CAACsB,IAAL,CAAUC,KAAX,CAAN,CAAwBC,OAAxB,CAAgC,CAAC,CAAC,CAAD,CAAD,CAAhC;MACD,CAHH,EAIGN,IAJH,CAIQ,MAAMT,IAAI,EAJlB,EAKGU,KALH,CAKSV,IALT;IAMD,CAdG,CADN;EAiBD,CAtEO,CAAR;EAwEAW,IAAI,CAAC,6BAAD,EAAiCX,IAAD,IAAU;IAC5C,IAAIsB,mBAAJ,GACGC,QADH,CACYtB,gBADZ,EAEGsB,QAFH,CAEY,IAAAC,oBAAA,EAAS,KAAT,EAAgB1C,GAAhB,CAFZ,EAGGyC,QAHH,CAGY,IAAAC,oBAAA,EAAS,UAAT,EAAqB,YAArB,CAHZ,EAIGD,QAJH,CAIY,IAAAC,oBAAA,EAAS,MAAT,EAAiBjC,IAAjB,CAJZ,EAKGkC,GALH,CAKO,CAAC,SAAD,CALP,EAMGhB,IANH,CAMQ,MAAM;MACVG,MAAM,CAAC9B,GAAG,CAAC+B,IAAJ,CAASC,KAAV,CAAN,CAAuBC,OAAvB,CAA+B,CAC7B,CAAC,SAAD,EAAY,2CAAZ,CAD6B,EAE7B,CAAC,OAAD,EAAU,mCAAV,CAF6B,CAA/B;IAID,CAXH,EAYGN,IAZH,CAYQ,MAAMT,IAAI,EAZlB,EAaGU,KAbH,CAaSV,IAbT;EAcD,CAfG,CAAJ;AAgBD,CA5GO,CAAR"}