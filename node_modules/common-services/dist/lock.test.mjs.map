{"version":3,"file":"lock.test.mjs","names":["Knifecycle","constant","initLockService","initDelayService","YError","describe","log","jest","fn","delay","create","clear","beforeEach","mockReset","test","testDelay","lock","expect","toEqual","mock","calls","toMatchInlineSnapshot","mockClear","take","release","lockOrder","releaseOrder","Promise","all","then","push","service","logCalls","err","code","params","done","register","run","toBeTruthy","catch"],"sources":["../src/lock.test.ts"],"sourcesContent":["import Knifecycle, { constant } from 'knifecycle';\nimport initLockService from './lock';\nimport initDelayService from './delay';\nimport YError from 'yerror';\n\ndescribe('initLockService', () => {\n  const log = jest.fn();\n  const delay = {\n    create: jest.fn(),\n    clear: jest.fn(),\n  };\n\n  beforeEach(() => {\n    log.mockReset();\n    delay.create.mockReset();\n    delay.clear.mockReset();\n  });\n\n  test('should work', async () => {\n    const testDelay = await initDelayService({});\n    const lock = await initLockService<string>({\n      log,\n      delay,\n    });\n\n    expect(typeof lock).toEqual('object');\n    expect(log.mock.calls).toMatchInlineSnapshot(`\n      Array [\n        Array [\n          \"debug\",\n          \"🔒 - Lock service initialized.\",\n        ],\n      ]\n    `);\n    log.mockClear();\n\n    await lock.take('key');\n    await lock.take('key2');\n    lock.release('key');\n    lock.release('key2');\n\n    expect(log.mock.calls).toMatchInlineSnapshot(`\n      Array [\n        Array [\n          \"debug\",\n          \"🔐 - Taking the lock on \\\\\"key\\\\\" (queue length was 0)\",\n        ],\n        Array [\n          \"debug\",\n          \"🔐 - Taking the lock on \\\\\"key2\\\\\" (queue length was 0)\",\n        ],\n        Array [\n          \"debug\",\n          \"🔓 - Releasing the lock on \\\\\"key\\\\\" (queue length was 1)\",\n        ],\n        Array [\n          \"debug\",\n          \"🔓 - Releasing the lock on \\\\\"key2\\\\\" (queue length was 1)\",\n        ],\n      ]\n    `);\n    log.mockClear();\n\n    const lockOrder: number[] = [];\n    const releaseOrder: number[] = [];\n\n    await Promise.all([\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(1), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(1)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(2), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(2)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(3), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(3)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(4), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(4)),\n    ]);\n\n    expect({\n      releaseOrder,\n      lockOrder,\n      logCalls: log.mock.calls,\n    }).toMatchInlineSnapshot(`\n      Object {\n        \"lockOrder\": Array [\n          1,\n          2,\n          3,\n          4,\n        ],\n        \"logCalls\": Array [\n          Array [\n            \"debug\",\n            \"🔐 - Taking the lock on \\\\\"key\\\\\" (queue length was 0)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔐 - Taking the lock on \\\\\"key\\\\\" (queue length was 1)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔐 - Taking the lock on \\\\\"key\\\\\" (queue length was 2)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔐 - Taking the lock on \\\\\"key\\\\\" (queue length was 3)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔓 - Releasing the lock on \\\\\"key\\\\\" (queue length was 4)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔓 - Releasing the lock on \\\\\"key\\\\\" (queue length was 3)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔓 - Releasing the lock on \\\\\"key\\\\\" (queue length was 2)\",\n          ],\n          Array [\n            \"debug\",\n            \"🔓 - Releasing the lock on \\\\\"key\\\\\" (queue length was 1)\",\n          ],\n        ],\n        \"releaseOrder\": Array [\n          1,\n          2,\n          3,\n          4,\n        ],\n      }\n    `);\n  });\n\n  test('should fail when no lock', async () => {\n    const lock = await initLockService({\n      log,\n      delay,\n    });\n\n    try {\n      await lock.release('key');\n      throw new YError('E_UNEXPECTED_SUCCESS');\n    } catch (err) {\n      expect({\n        code: (err as YError).code,\n        params: (err as YError).params,\n      }).toMatchInlineSnapshot(`\n        Object {\n          \"code\": \"E_NO_LOCK\",\n          \"params\": Array [\n            \"key\",\n          ],\n        }\n      `);\n      expect(log.mock.calls).toMatchInlineSnapshot(`\n        Array [\n          Array [\n            \"debug\",\n            \"🔒 - Lock service initialized.\",\n          ],\n        ]\n      `);\n    }\n  });\n\n  test('should work with Knifecycle', (done) => {\n    new Knifecycle()\n      .register(initLockService)\n      .register(constant('log', log))\n      .register(constant('delay', delay))\n      .run(['lock'])\n      .then(({ lock }) => {\n        expect(lock).toBeTruthy();\n        expect(log.mock.calls).toMatchInlineSnapshot(`\n          Array [\n            Array [\n              \"debug\",\n              \"🔒 - Lock service initialized.\",\n            ],\n          ]\n        `);\n      })\n      .then(() => done())\n      .catch(done);\n  });\n});\n"],"mappings":"AAAA,OAAOA,UAAP,IAAqBC,QAArB,QAAqC,YAArC;AACA,OAAOC,eAAP,MAA4B,QAA5B;AACA,OAAOC,gBAAP,MAA6B,SAA7B;AACA,OAAOC,MAAP,MAAmB,QAAnB;AAEAC,QAAQ,CAAC,iBAAD,EAAoB,MAAM;EAChC,MAAMC,GAAG,GAAGC,IAAI,CAACC,EAAL,EAAZ;EACA,MAAMC,KAAK,GAAG;IACZC,MAAM,EAAEH,IAAI,CAACC,EAAL,EADI;IAEZG,KAAK,EAAEJ,IAAI,CAACC,EAAL;EAFK,CAAd;EAKAI,UAAU,CAAC,MAAM;IACfN,GAAG,CAACO,SAAJ;IACAJ,KAAK,CAACC,MAAN,CAAaG,SAAb;IACAJ,KAAK,CAACE,KAAN,CAAYE,SAAZ;EACD,CAJS,CAAV;EAMAC,IAAI,CAAC,aAAD,EAAgB,YAAY;IAC9B,MAAMC,SAAS,GAAG,MAAMZ,gBAAgB,CAAC,EAAD,CAAxC;IACA,MAAMa,IAAI,GAAG,MAAMd,eAAe,CAAS;MACzCI,GADyC;MAEzCG;IAFyC,CAAT,CAAlC;IAKAQ,MAAM,CAAC,OAAOD,IAAR,CAAN,CAAoBE,OAApB,CAA4B,QAA5B;IACAD,MAAM,CAACX,GAAG,CAACa,IAAJ,CAASC,KAAV,CAAN,CAAuBC,qBAAvB,CAA8C;AAClD;AACA;AACA;AACA;AACA;AACA;AACA,KAPI;IAQAf,GAAG,CAACgB,SAAJ;IAEA,MAAMN,IAAI,CAACO,IAAL,CAAU,KAAV,CAAN;IACA,MAAMP,IAAI,CAACO,IAAL,CAAU,MAAV,CAAN;IACAP,IAAI,CAACQ,OAAL,CAAa,KAAb;IACAR,IAAI,CAACQ,OAAL,CAAa,MAAb;IAEAP,MAAM,CAACX,GAAG,CAACa,IAAJ,CAASC,KAAV,CAAN,CAAuBC,qBAAvB,CAA8C;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAnBI;IAoBAf,GAAG,CAACgB,SAAJ;IAEA,MAAMG,SAAmB,GAAG,EAA5B;IACA,MAAMC,YAAsB,GAAG,EAA/B;IAEA,MAAMC,OAAO,CAACC,GAAR,CAAY,CAChBZ,IAAI,CACDO,IADH,CACQ,KADR,EAEGM,IAFH,CAEQ,OAAOJ,SAAS,CAACK,IAAV,CAAe,CAAf,GAAmBf,SAAS,CAACgB,OAAV,CAAkBrB,MAAlB,CAAyB,EAAzB,CAA1B,CAFR,EAGGmB,IAHH,CAGQ,MAAMb,IAAI,CAACQ,OAAL,CAAa,KAAb,CAHd,EAIGK,IAJH,CAIQ,MAAMH,YAAY,CAACI,IAAb,CAAkB,CAAlB,CAJd,CADgB,EAMhBd,IAAI,CACDO,IADH,CACQ,KADR,EAEGM,IAFH,CAEQ,OAAOJ,SAAS,CAACK,IAAV,CAAe,CAAf,GAAmBf,SAAS,CAACgB,OAAV,CAAkBrB,MAAlB,CAAyB,EAAzB,CAA1B,CAFR,EAGGmB,IAHH,CAGQ,MAAMb,IAAI,CAACQ,OAAL,CAAa,KAAb,CAHd,EAIGK,IAJH,CAIQ,MAAMH,YAAY,CAACI,IAAb,CAAkB,CAAlB,CAJd,CANgB,EAWhBd,IAAI,CACDO,IADH,CACQ,KADR,EAEGM,IAFH,CAEQ,OAAOJ,SAAS,CAACK,IAAV,CAAe,CAAf,GAAmBf,SAAS,CAACgB,OAAV,CAAkBrB,MAAlB,CAAyB,EAAzB,CAA1B,CAFR,EAGGmB,IAHH,CAGQ,MAAMb,IAAI,CAACQ,OAAL,CAAa,KAAb,CAHd,EAIGK,IAJH,CAIQ,MAAMH,YAAY,CAACI,IAAb,CAAkB,CAAlB,CAJd,CAXgB,EAgBhBd,IAAI,CACDO,IADH,CACQ,KADR,EAEGM,IAFH,CAEQ,OAAOJ,SAAS,CAACK,IAAV,CAAe,CAAf,GAAmBf,SAAS,CAACgB,OAAV,CAAkBrB,MAAlB,CAAyB,EAAzB,CAA1B,CAFR,EAGGmB,IAHH,CAGQ,MAAMb,IAAI,CAACQ,OAAL,CAAa,KAAb,CAHd,EAIGK,IAJH,CAIQ,MAAMH,YAAY,CAACI,IAAb,CAAkB,CAAlB,CAJd,CAhBgB,CAAZ,CAAN;IAuBAb,MAAM,CAAC;MACLS,YADK;MAELD,SAFK;MAGLO,QAAQ,EAAE1B,GAAG,CAACa,IAAJ,CAASC;IAHd,CAAD,CAAN,CAIGC,qBAJH,CAI0B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KArDI;EAsDD,CA7HG,CAAJ;EA+HAP,IAAI,CAAC,0BAAD,EAA6B,YAAY;IAC3C,MAAME,IAAI,GAAG,MAAMd,eAAe,CAAC;MACjCI,GADiC;MAEjCG;IAFiC,CAAD,CAAlC;;IAKA,IAAI;MACF,MAAMO,IAAI,CAACQ,OAAL,CAAa,KAAb,CAAN;MACA,MAAM,IAAIpB,MAAJ,CAAW,sBAAX,CAAN;IACD,CAHD,CAGE,OAAO6B,GAAP,EAAY;MACZhB,MAAM,CAAC;QACLiB,IAAI,EAAGD,GAAD,CAAgBC,IADjB;QAELC,MAAM,EAAGF,GAAD,CAAgBE;MAFnB,CAAD,CAAN,CAGGd,qBAHH,CAG0B;AAChC;AACA;AACA;AACA;AACA;AACA;AACA,OAVM;MAWAJ,MAAM,CAACX,GAAG,CAACa,IAAJ,CAASC,KAAV,CAAN,CAAuBC,qBAAvB,CAA8C;AACpD;AACA;AACA;AACA;AACA;AACA;AACA,OAPM;IAQD;EACF,CA9BG,CAAJ;EAgCAP,IAAI,CAAC,6BAAD,EAAiCsB,IAAD,IAAU;IAC5C,IAAIpC,UAAJ,GACGqC,QADH,CACYnC,eADZ,EAEGmC,QAFH,CAEYpC,QAAQ,CAAC,KAAD,EAAQK,GAAR,CAFpB,EAGG+B,QAHH,CAGYpC,QAAQ,CAAC,OAAD,EAAUQ,KAAV,CAHpB,EAIG6B,GAJH,CAIO,CAAC,MAAD,CAJP,EAKGT,IALH,CAKQ,CAAC;MAAEb;IAAF,CAAD,KAAc;MAClBC,MAAM,CAACD,IAAD,CAAN,CAAauB,UAAb;MACAtB,MAAM,CAACX,GAAG,CAACa,IAAJ,CAASC,KAAV,CAAN,CAAuBC,qBAAvB,CAA8C;AACtD;AACA;AACA;AACA;AACA;AACA;AACA,SAPQ;IAQD,CAfH,EAgBGQ,IAhBH,CAgBQ,MAAMO,IAAI,EAhBlB,EAiBGI,KAjBH,CAiBSJ,IAjBT;EAkBD,CAnBG,CAAJ;AAoBD,CAhMO,CAAR"}