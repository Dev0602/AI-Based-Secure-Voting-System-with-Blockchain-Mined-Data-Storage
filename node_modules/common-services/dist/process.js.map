{"version":3,"file":"process.js","names":["DEFAULT_NODE_ENVS","DEFAULT_SIGNALS","noop","undefined","singleton","autoProvider","initProcess","NODE_ENV","PROCESS_NAME","SIGNALS","NODE_ENVS","log","exit","$instance","$fatalError","signalsListeners","map","signal","terminate","bind","shuttingDown","includes","YError","global","process","title","forEach","signalListener","on","promise","catch","err","stack","catchUncaughtException","shutdown","code","destroy","dispose","removeListener","service"],"sources":["../src/process.ts"],"sourcesContent":["import YError from 'yerror';\nimport { autoProvider, singleton } from 'knifecycle';\nimport type { FatalErrorService, Knifecycle } from 'knifecycle';\nimport type { LogService } from './log';\n\nconst DEFAULT_NODE_ENVS = ['development', 'test', 'production'];\nconst DEFAULT_SIGNALS: NodeJS.Signals[] = ['SIGTERM', 'SIGINT'];\n\nfunction noop(): void {\n  return undefined;\n}\n\nexport type ProcessServiceConfig = {\n  NODE_ENV?: string;\n  PROCESS_NAME?: string;\n  SIGNALS?: NodeJS.Signals[];\n  NODE_ENVS?: string[];\n};\nexport type ProcessServiceDependencies = ProcessServiceConfig & {\n  NODE_ENV: string;\n  exit: typeof process.exit;\n  $instance: Knifecycle;\n  $fatalError: FatalErrorService;\n  log?: LogService;\n};\n\n/* Architecture Note #1.5: Process\nThe `process` service takes care of the process status.\n\nIt returns nothing and should be injected only for its\n side effects.\n*/\n\nexport default singleton(autoProvider(initProcess));\n\n/**\n * Instantiate the process service\n * @name initProcess\n * @function\n * @param  {Object}   services\n * The services to inject\n * @return {Promise<Object>}\n * A promise of the process object\n */\nasync function initProcess({\n  NODE_ENV,\n  PROCESS_NAME = '',\n  SIGNALS = DEFAULT_SIGNALS,\n  NODE_ENVS = DEFAULT_NODE_ENVS,\n  log = noop,\n  exit,\n  $instance,\n  $fatalError,\n}: ProcessServiceDependencies): Promise<{\n  service: NodeJS.Process;\n  dispose: () => Promise<void>;\n}> {\n  const signalsListeners = SIGNALS.map<\n    [NodeJS.Signals, NodeJS.SignalsListener]\n  >((signal) => [signal, terminate.bind(null, signal)]);\n  let shuttingDown = false;\n\n  /* Architecture Note #1.5.1: Node environment filtering\n\n  It also forces NODE_ENV to be set to avoid unintentionnal\n   development version shipping to production. You can specify\n   your own list of valid environments by injecting the\n   `SIGNALS` optional dependency.\n  */\n  if (!NODE_ENVS.includes(NODE_ENV)) {\n    throw new YError('E_NODE_ENV', NODE_ENV);\n  }\n\n  log('warning', `ðŸ”‚ - Running in \"${NODE_ENV}\" environment.`);\n\n  global.process.title =\n    (PROCESS_NAME || global.process.title) + ' - ' + NODE_ENV;\n\n  /* Architecture Note #1.5.2: Signals handling\n\n  It also handle SIGINT and SIGTERM signals to allow to\n   gracefully shutdown the running process. The signals\n   to handle can be customized by injecting the `SIGNALS`\n   optional dependencies.\n  */\n  signalsListeners.forEach(([signal, signalListener]) => {\n    global.process.on(signal, signalListener);\n  });\n\n  /* Architecture Note #1.5.3: Handling services fatal errors\n\n  If an error occurs it attempts to gracefully exit\n  to give it a chance to finish properly.\n  */\n  $fatalError.promise.catch((err) => {\n    log('error', 'ðŸ’€ - Fatal error');\n    log('error-stack', err.stack || err);\n    terminate('FATAL');\n  });\n\n  /* Architecture Note #1.5.4: Uncaught exceptions\n\n  If an uncaught exeption occurs it also attempts to\n   gracefully exit since a process should never be kept\n   alive when an uncaught exception is raised.\n  */\n  global.process.on('uncaughtException', catchUncaughtException);\n\n  function catchUncaughtException(err: Error) {\n    log('error', 'ðŸ’€ - Uncaught Exception');\n    log(\n      'error-stack',\n      (err as Error).stack ||\n        // Catching anything that could be inside err\n        // since some people have the nice idea to\n        // throw undefined or just a string.\n        '' + (err as unknown as string),\n    );\n    terminate('ERR');\n  }\n\n  function terminate(signal: NodeJS.Signals | 'ERR' | 'FATAL') {\n    if (shuttingDown) {\n      log('warning', `ðŸš¦ - ${signal} received again, shutdown now.`);\n      exit(1);\n    } else {\n      log(\n        'warning',\n        `ðŸš¦ - ${signal} received. Send it again to kill me instantly.`,\n      );\n      shutdown(['ERR', 'FATAL'].includes(signal) ? 1 : 0);\n    }\n  }\n\n  async function shutdown(code: number) {\n    shuttingDown = true;\n    log('warning', 'Shutting down now ðŸ™...');\n    await $instance.destroy();\n\n    try {\n      log('warning', 'ðŸ˜Ž - Gracefull shutdown sucessfully done !');\n      exit(code);\n    } catch (err) {\n      log('error', 'ðŸ¤” - Could not gracefully shutdown.');\n      log(\n        'error-stack',\n        (err as Error).stack ||\n          // Catching anything that could be inside err\n          // since some people have the nice idea to\n          // throw undefined or just a string.\n          '' + (err as unknown as string),\n      );\n      exit(code);\n    }\n  }\n\n  async function dispose() {\n    global.process.removeListener('uncaughtException', catchUncaughtException);\n    signalsListeners.forEach(([signal, signalListener]) => {\n      global.process.removeListener(signal, signalListener);\n    });\n  }\n\n  log('debug', 'ðŸ“‡ - Process service initialized.');\n  return {\n    service: global.process,\n    dispose,\n  };\n}\n"],"mappings":"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"}