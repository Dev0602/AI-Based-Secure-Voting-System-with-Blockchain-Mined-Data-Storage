{"version":3,"file":"lock.test.js","names":["describe","log","jest","fn","delay","create","clear","beforeEach","mockReset","test","testDelay","initDelayService","lock","initLockService","expect","toEqual","mock","calls","toMatchInlineSnapshot","mockClear","take","release","lockOrder","releaseOrder","Promise","all","then","push","service","logCalls","YError","err","code","params","done","Knifecycle","register","constant","run","toBeTruthy","catch"],"sources":["../src/lock.test.ts"],"sourcesContent":["import Knifecycle, { constant } from 'knifecycle';\nimport initLockService from './lock';\nimport initDelayService from './delay';\nimport YError from 'yerror';\n\ndescribe('initLockService', () => {\n  const log = jest.fn();\n  const delay = {\n    create: jest.fn(),\n    clear: jest.fn(),\n  };\n\n  beforeEach(() => {\n    log.mockReset();\n    delay.create.mockReset();\n    delay.clear.mockReset();\n  });\n\n  test('should work', async () => {\n    const testDelay = await initDelayService({});\n    const lock = await initLockService<string>({\n      log,\n      delay,\n    });\n\n    expect(typeof lock).toEqual('object');\n    expect(log.mock.calls).toMatchInlineSnapshot(`\n      Array [\n        Array [\n          \"debug\",\n          \"ðŸ”’ - Lock service initialized.\",\n        ],\n      ]\n    `);\n    log.mockClear();\n\n    await lock.take('key');\n    await lock.take('key2');\n    lock.release('key');\n    lock.release('key2');\n\n    expect(log.mock.calls).toMatchInlineSnapshot(`\n      Array [\n        Array [\n          \"debug\",\n          \"ðŸ” - Taking the lock on \\\\\"key\\\\\" (queue length was 0)\",\n        ],\n        Array [\n          \"debug\",\n          \"ðŸ” - Taking the lock on \\\\\"key2\\\\\" (queue length was 0)\",\n        ],\n        Array [\n          \"debug\",\n          \"ðŸ”“ - Releasing the lock on \\\\\"key\\\\\" (queue length was 1)\",\n        ],\n        Array [\n          \"debug\",\n          \"ðŸ”“ - Releasing the lock on \\\\\"key2\\\\\" (queue length was 1)\",\n        ],\n      ]\n    `);\n    log.mockClear();\n\n    const lockOrder: number[] = [];\n    const releaseOrder: number[] = [];\n\n    await Promise.all([\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(1), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(1)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(2), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(2)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(3), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(3)),\n      lock\n        .take('key')\n        .then(() => (lockOrder.push(4), testDelay.service.create(10)))\n        .then(() => lock.release('key'))\n        .then(() => releaseOrder.push(4)),\n    ]);\n\n    expect({\n      releaseOrder,\n      lockOrder,\n      logCalls: log.mock.calls,\n    }).toMatchInlineSnapshot(`\n      Object {\n        \"lockOrder\": Array [\n          1,\n          2,\n          3,\n          4,\n        ],\n        \"logCalls\": Array [\n          Array [\n            \"debug\",\n            \"ðŸ” - Taking the lock on \\\\\"key\\\\\" (queue length was 0)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ” - Taking the lock on \\\\\"key\\\\\" (queue length was 1)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ” - Taking the lock on \\\\\"key\\\\\" (queue length was 2)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ” - Taking the lock on \\\\\"key\\\\\" (queue length was 3)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ”“ - Releasing the lock on \\\\\"key\\\\\" (queue length was 4)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ”“ - Releasing the lock on \\\\\"key\\\\\" (queue length was 3)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ”“ - Releasing the lock on \\\\\"key\\\\\" (queue length was 2)\",\n          ],\n          Array [\n            \"debug\",\n            \"ðŸ”“ - Releasing the lock on \\\\\"key\\\\\" (queue length was 1)\",\n          ],\n        ],\n        \"releaseOrder\": Array [\n          1,\n          2,\n          3,\n          4,\n        ],\n      }\n    `);\n  });\n\n  test('should fail when no lock', async () => {\n    const lock = await initLockService({\n      log,\n      delay,\n    });\n\n    try {\n      await lock.release('key');\n      throw new YError('E_UNEXPECTED_SUCCESS');\n    } catch (err) {\n      expect({\n        code: (err as YError).code,\n        params: (err as YError).params,\n      }).toMatchInlineSnapshot(`\n        Object {\n          \"code\": \"E_NO_LOCK\",\n          \"params\": Array [\n            \"key\",\n          ],\n        }\n      `);\n      expect(log.mock.calls).toMatchInlineSnapshot(`\n        Array [\n          Array [\n            \"debug\",\n            \"ðŸ”’ - Lock service initialized.\",\n          ],\n        ]\n      `);\n    }\n  });\n\n  test('should work with Knifecycle', (done) => {\n    new Knifecycle()\n      .register(initLockService)\n      .register(constant('log', log))\n      .register(constant('delay', delay))\n      .run(['lock'])\n      .then(({ lock }) => {\n        expect(lock).toBeTruthy();\n        expect(log.mock.calls).toMatchInlineSnapshot(`\n          Array [\n            Array [\n              \"debug\",\n              \"ðŸ”’ - Lock service initialized.\",\n            ],\n          ]\n        `);\n      })\n      .then(() => done())\n      .catch(done);\n  });\n});\n"],"mappings":"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"}