{"version":3,"file":"delay.mock.js","names":["reuseSpecialProps","initDelayService","initDelayMock","_","pendingPromises","Promise","resolve","service","create","clear","__resolve","__resolveAll","__reject","__rejectAll","_resolve","_reject","promise","reject","push","pendingPromiseIndex","findIndex","pendingPromise","YError","splice","find","undefined","then","__delete","bind","all","map"],"sources":["../src/delay.mock.ts"],"sourcesContent":["import YError from 'yerror';\nimport initDelayService from './delay';\nimport { reuseSpecialProps } from 'knifecycle';\n\n/* Architecture Note #1.4.1: Mocking delays\n\nThis mock is largely inspired by the `$timeout` one of\n AngularJS. It allows to resolve/reject pending delays\n for testing. That said, it does it asynchronously\n where the former one was synchronous. This is not a\n bug but a design choice to keep the closest possible\n to what would happen in actual code.\n*/\n\nexport default reuseSpecialProps(\n  initDelayService as unknown as typeof initDelayMock,\n  initDelayMock,\n);\n\n/**\n * Instantiate the delay service mock\n * @name initDelayMock\n * @function\n * @return {Promise<Object>}\n * A promise of the mocked delay service\n * @example\n * import initDelayMock from 'common-services/dist/delay.mock';\n * import assert from 'assert';\n *\n * const delay = await initDelayMock();\n *\n * const delayPromise = delay.create(1000);\n *\n * delay.resolve(delayPromise);\n *\n * delayPromise.then(() => {\n *   // Any code here will execute immediatly\n *   // instead of after a 1000ms delay\n * });\n */\nfunction initDelayMock(_: unknown): Promise<{\n  service: {\n    create: (delay: number) => Promise<void>;\n    clear: (promise: Promise<void>) => Promise<void>;\n    __resolve: (promise: Promise<void>) => Promise<void>;\n    __resolveAll: () => Promise<void>;\n    __reject: (promise: Promise<void>) => Promise<void>;\n    __rejectAll: () => Promise<void>;\n  };\n}> {\n  const pendingPromises: {\n    promise: Promise<void>;\n    resolve: Parameters<ConstructorParameters<typeof Promise>[0]>[0];\n    reject: Parameters<ConstructorParameters<typeof Promise>[0]>[1];\n  }[] = [];\n\n  return Promise.resolve({\n    service: {\n      create,\n      clear,\n      __resolve,\n      __resolveAll,\n      __reject,\n      __rejectAll,\n    },\n  });\n\n  function create(_: number): Promise<void> {\n    let _resolve;\n    let _reject;\n    const promise = new Promise<void>((resolve, reject) => {\n      _reject = reject;\n      _resolve = resolve;\n    });\n\n    pendingPromises.push({\n      promise,\n      resolve: _resolve,\n      reject: _reject,\n    });\n    return promise as Promise<void>;\n  }\n\n  async function clear(promise: Promise<void>) {\n    const pendingPromiseIndex = pendingPromises.findIndex(\n      (pendingPromise) => pendingPromise.promise === promise,\n    );\n\n    if (-1 === pendingPromiseIndex) {\n      return Promise.reject(new YError('E_BAD_DELAY'));\n    }\n    pendingPromises[pendingPromiseIndex].reject(new YError('E_DELAY_CLEARED'));\n    pendingPromises.splice(pendingPromiseIndex, 1);\n    return Promise.resolve() as Promise<void>;\n  }\n\n  function __resolve(promise: Promise<void>) {\n    const pendingPromise = pendingPromises.find(\n      (pendingPromise) => pendingPromise.promise === promise,\n    );\n\n    if (!pendingPromise) {\n      return Promise.reject(new YError('E_BAD_DELAY'));\n    }\n    pendingPromise.resolve(undefined);\n    return Promise.resolve().then(__delete.bind(null, promise));\n  }\n\n  async function __resolveAll() {\n    await Promise.all(pendingPromises.map(({ promise }) => __resolve(promise)));\n  }\n\n  function __reject(promise) {\n    const pendingPromise = pendingPromises.find(\n      (pendingPromise) => pendingPromise.promise === promise,\n    );\n\n    if (!pendingPromise) {\n      return Promise.reject(new YError('E_BAD_DELAY'));\n    }\n    pendingPromise.reject(new YError('E_DELAY_CLEARED'));\n    return Promise.resolve().then(__delete.bind(null, promise));\n  }\n\n  async function __rejectAll() {\n    await Promise.all(pendingPromises.map(({ promise }) => __reject(promise)));\n  }\n\n  function __delete(promise: Promise<void>) {\n    const pendingPromiseIndex = pendingPromises.findIndex(\n      (pendingPromise) => pendingPromise.promise === promise,\n    );\n    pendingPromises.splice(pendingPromiseIndex, 1);\n  }\n}\n"],"mappings":"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"}